name: Publish Package

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Resolve pnpm version from packageManager
        id: pnpm-version
        run: |
          PM=$(node -p "require('./package.json').packageManager || ''")
          if [ -z "$PM" ]; then
            echo "package.json is missing packageManager"
            exit 1
          fi
          echo "version=${PM#pnpm@}" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ steps.pnpm-version.outputs.version }}

      - name: Show tool versions
        run: |
          node --version
          npm --version
          pnpm --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test

      - name: Build package
        run: pnpm run build

      - name: Prepare publish directory
        run: |
          rm -rf publish artifacts smoke
          mkdir -p publish
          cp -R dist publish/dist

          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            delete pkg.scripts;
            delete pkg.devDependencies;
            delete pkg['lint-staged'];
            fs.writeFileSync('publish/package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          cp README.md publish/ || true
          cp LICENSE publish/ || true

      - name: Verify publish integrity
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('publish/package.json', 'utf8'));
            const required = [pkg.main, pkg.module, pkg.types];
            for (const rel of required) {
              if (!rel || !fs.existsSync('publish/' + rel)) {
                throw new Error('Missing publish artifact: ' + rel);
              }
            }
            console.log('Publish integrity verification passed');
          "

      - name: Pack tarball
        run: |
          mkdir -p artifacts
          cd publish
          pnpm pack --pack-destination ../artifacts

      - name: Tarball smoke install check
        run: |
          mkdir -p smoke
          cd smoke
          printf '{\n  "name": "smoke",\n  "private": true\n}\n' > package.json
          pnpm add ../artifacts/*.tgz
          node -e "const pkg = require('@24vlh/ts-helpers'); console.log('Loaded package exports:', Object.keys(pkg).length);"

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: ts-helpers-publish
          path: publish/

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: ts-helpers-publish
          path: publish/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Show tool versions (publish job)
        run: |
          node --version
          npm --version

      - name: Publish to npm (trusted publishing)
        run: npm publish --access public --provenance
        working-directory: publish
